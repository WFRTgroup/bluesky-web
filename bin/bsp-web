#! /usr/bin/env python

__author__ = "Joel Dubowy"
__copyright__ = "Copyright 2015, AirFire, PNW, USFS"

import sys
import traceback

import tornado.ioloop
import tornado.log

import afscripting as scripting

try:
    from blueskyweb.app import main
except:
    import os
    root_dir = os.path.abspath(os.path.join(sys.path[0], '../'))
    sys.path.insert(0, root_dir)
    from blueskyweb.app import main

OPTIONAL_ARGS = [
    {
        'long': '--path-prefix',
        'help': "Url root path prefix to apply to all routes; e.g. '/outlooks'"
    },
    {
        'short': '-p',
        'long': '--port',
        'help': 'run the server listening on specified port',
        'default': 8888
    },
    {
        'short': '-d',
        'long': '--debug',
        'help': 'run the server in debug mode (with auto-reloading of code, etc.)',
        'action': "store_true",
        'default': False
    },
    {
        'long': '--mongodb-url',
        'help': 'url to connect to mongodb for arl indexes and bsp job queues'
    }
]

# Note: the trailing space seems to be the only way to add an extra trailing line
EPILOG_STR = """
Examples

   $ {script_name} --log-level=DEBUG -d --path-prefix=bluesky \\
        --mongodb-url=mongodb://localhost:27018/blueskyweb

Example curl Requests

    $ curl "http://localhost:8888/blueskyweb/api/ping/"
 """.format(script_name=sys.argv[0])

if __name__ == "__main__":
    parser = scripting.args.ArgumentParser()
    parser.epilog = EPILOG_STR
    parser.formatter_class = scripting.args.RawTextHelpFormatter
    scripting.args.add_arguments(parser, OPTIONAL_ARGS)
    # Use afscripting to add logging options to the parser object,
    # but we'll configure logging oureselves in app.main
    scripting.args.add_logging_options(parser)
    args = parser.parse_args()

    try:
        main(**args.__dict__)
    except Exception as e:
        tornado.log.gen_log.debug(traceback.format_exc())
        tornado.log.gen_log.error(e)
        sys.exit(1)
