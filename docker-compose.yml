# *** This docker-compose.yml is for dev purposes ***
# Note: letting restart policy be the default 'no' so that
#   I don't have to explicity call 'down' to free up web and mongo
#   ports in case I want to switch to running processes manually
#   or with foreman
version: '2'
services:
  web:
    image: bluesky-web
    container_name: bluesky-web
    ports:
    - 8887:8887
    volumes:
    - ./:/usr/src/blueskyweb/
    - ./docker-logs/web/:/var/log/blueskyweb/
    - /var/run/docker.sock:/var/run/docker.sock
    links:
    - mongo
    # note: log should be in /var/log/blueskyweb/bluesky-web.log, the default
    command: bsp-web -d -b bluesky --path-prefix=bluesky --mongodb-url=mongodb://blueskyweb:blueskywebmongopassword@mongo/blueskyweb -p 8887 --log-level=DEBUG --output-url-scheme=http --output-url-port=8886 --output-url-path-prefix=
  mongo:
    image: mongo:3.4.6
    container_name: bluesky-web-mongo
    environment:
    # These are meant to be overridden
    - MONGO_INITDB_ROOT_USERNAME=blueskyweb
    - MONGO_INITDB_ROOT_PASSWORD=blueskywebmongopassword
    ports:
    - 27018:27017
    volumes:
    - ./docker-logs/mongodb/:/var/log/mongodb/
    - ./docker-data/mongodb/db/:/data/db/
    - ./docker-data/mongodb/configdb/:/data/configdb/
    #- ./mongo-entrypoint/:/docker-entrypoint-initdb.d/
    # Note: '--auth' is automatically added to command if
    #   MONGO_INITDB_ROOT_[USERNAME|PASSWORD] are set
    # see
    #   - https://stackoverflow.com/questions/34559557/how-to-enable-authentication-on-mongodb-through-docker
    #   - https://github.com/docker-library/mongo/blob/27f2722bb2ebd26354321adc8c3f19f7958529e1/3.4/Dockerfile
    #   - https://github.com/docker-library/mongo/blob/27f2722bb2ebd26354321adc8c3f19f7958529e1/3.4/docker-entrypoint.sh
    #command: mongod --auth
  output_web:
    image: python:3.5-alpine
    container_name: bluesky-web-output
    volumes:
    - ./docker-data/output/:/data/output/
    working_dir: /data/output/
    command: python -m http.server 8886
  worker_all_met:
    image: bluesky-web
    container_name: bluesky-web-worker-all-met
    volumes:
    - ./:/usr/src/blueskyweb/
    - ./docker-logs/worker/all-met/:/var/log/blueskyworker/
    - /var/run/docker.sock:/var/run/docker.sock
    environment:
    - MONGODB_URL=mongodb://blueskyweb:blueskywebmongopassword@localhost:27018/blueskyweb
    command: celery -Q all-met -c 5 -A blueskyworker.tasks worker -l DEBUG -f /var/log/blueskyworker/bluesky-web-worker-all-met.log
  worker_dri:
    image: bluesky-web
    container_name: bluesky-web-worker-dri
    volumes:
    - ./:/usr/src/blueskyweb/
    - ./docker-logs/worker/dri/:/var/log/blueskyworker/
    - /var/run/docker.sock:/var/run/docker.sock
    environment:
    - MONGODB_URL=mongodb://blueskyweb:blueskywebmongopassword@localhost:27018/blueskyweb
    command: celery -Q dri -c 5 -A blueskyworker.tasks worker -l DEBUG -f /var/log/blueskyworker/bluesky-web-worker-dri.log
  worker_nam:
    image: bluesky-web
    container_name: bluesky-web-worker-nam
    volumes:
    - ./:/usr/src/blueskyweb/
    - ./docker-logs/worker/nam/:/var/log/blueskyworker/
    - /var/run/docker.sock:/var/run/docker.sock
    environment:
    - MONGODB_URL=mongodb://blueskyweb:blueskywebmongopassword@localhost:27018/blueskyweb
    command: celery -Q nam -c 5 -A blueskyworker.tasks worker -l DEBUG -f /var/log/blueskyworker/bluesky-web-worker-nam.log
